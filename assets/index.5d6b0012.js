var T=Object.defineProperty;var A=(s,e,r)=>e in s?T(s,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):s[e]=r;var t=(s,e,r)=>(A(s,typeof e!="symbol"?e+"":e,r),r);import{U as g,_ as B,R as y}from"./vendor.5b22622a.js";import{c as m,t as D,f as w,g as V,h as C,i as z,m as _,l as O,p as U}from"./vec3.d4a804b7.js";/* empty css              */let u;function R(s){u=s}var X=`@stage(fragment)
  fn main(@location(0) fragColor : vec4<f32>) -> @location(0) vec4<f32> {
    return fragColor;
  }`,Y=`struct Uniforms {
    modelViewProjectionMatrix : mat4x4<f32>;
  };
  
  @binding(0) @group(0) var<uniform> uniforms : Uniforms;
  
  struct VertexOutput {
    @builtin(position) Position : vec4<f32>;
    @location(0) fragColor : vec4<f32>;
  };
  
  @stage(vertex)
  fn main(@location(0) position : vec4<f32>,
          @location(1) color : vec4<f32>) -> VertexOutput {
    return VertexOutput(uniforms.modelViewProjectionMatrix * position, color);
  }`;const N=36,F=new Float32Array([1,-1,1,1,1,0,1,1,1,1,-1,-1,1,1,0,0,1,1,0,1,-1,-1,-1,1,0,0,0,1,0,0,1,-1,-1,1,1,0,0,1,1,0,1,-1,1,1,1,0,1,1,1,1,-1,-1,-1,1,0,0,0,1,0,0,1,1,1,1,1,1,1,1,1,1,1,-1,1,1,1,0,1,1,0,1,1,-1,-1,1,1,0,0,1,0,0,1,1,-1,1,1,1,0,1,1,0,1,1,1,1,1,1,1,1,1,1,1,-1,-1,1,1,0,0,1,0,0,-1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,-1,1,1,1,0,1,0,0,-1,1,-1,1,0,1,0,1,1,0,-1,1,1,1,0,1,1,1,1,1,1,1,-1,1,1,1,0,1,0,0,-1,-1,1,1,0,0,1,1,1,1,-1,1,1,1,0,1,1,1,0,1,-1,1,-1,1,0,1,0,1,0,0,-1,-1,-1,1,0,0,0,1,1,0,-1,-1,1,1,0,0,1,1,1,1,-1,1,-1,1,0,1,0,1,0,0,1,1,1,1,1,1,1,1,1,1,-1,1,1,1,0,1,1,1,0,1,-1,-1,1,1,0,0,1,1,0,0,-1,-1,1,1,0,0,1,1,0,0,1,-1,1,1,1,0,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,-1,-1,1,1,0,0,1,1,1,-1,-1,-1,1,0,0,0,1,0,1,-1,1,-1,1,0,1,0,1,0,0,1,1,-1,1,1,1,0,1,1,0,1,-1,-1,1,1,0,0,1,1,1,-1,1,-1,1,0,1,0,1,0,0]),G=19,q=new Float32Array([0,1,0,1,0,0,1,1,1,1,-1,-1,1,1,0,0,1,1,1,1,1,-1,1,1,0,0,1,1,1,1,1,-1,-1,1,0,1,0,1,1,1,0,1,0,1,0,1,0,1,1,1,1,-1,1,1,0,1,0,1,1,1,-1,-1,-1,1,1,1,0,1,1,1,1,-1,-1,1,1,1,0,1,1,1,1,-1,1,1,1,1,0,1,1,1,-1,-1,1,1,0,1,1,1,1,1,-1,-1,-1,1,0,1,1,1,1,1,1,-1,1,1,0,1,1,1,1,1,-1,-1,-1,1,1,.5,0,1,1,1,-1,-1,1,1,1,.5,0,1,1,1,0,1,0,1,1,.5,0,1,1,1,-1,-1,-1,1,1,.5,0,1,1,1,0,1,0,1,1,0,0,1,1,1,1,-1,-1,1,1,0,0,1,1,1,-1,-1,-1,1,1,0,0,1,1,1]),M={vertex:Y,fragment:X},Z=0,L=4*4,H=4*10;class h{constructor(e,r,n,o){t(this,"x",0);t(this,"y",0);t(this,"z",0);t(this,"rotX",0);t(this,"rotY",0);t(this,"rotZ",0);t(this,"matrixSize",4*16);t(this,"offset",256);t(this,"uniformBufferSize",this.offset+this.matrixSize);t(this,"modelViewProjectionMatrix",m());t(this,"renderPipeline");t(this,"uniformBuffer");t(this,"uniformBindGroup");t(this,"verticesBuffer");t(this,"vertexCount");this.vertexCount=n,this.renderPipeline=e.createRenderPipeline({vertex:{module:e.createShaderModule({code:M.vertex}),entryPoint:"main",buffers:[{arrayStride:H,attributes:[{shaderLocation:0,offset:Z,format:"float32x4"},{shaderLocation:1,offset:L,format:"float32x4"}]}]},fragment:{module:e.createShaderModule({code:M.fragment}),entryPoint:"main",targets:[{format:"bgra8unorm"}]},primitive:{topology:"triangle-list",cullMode:"back"},depthStencil:{depthWriteEnabled:!0,depthCompare:"less",format:"depth24plus-stencil8"}}),this.uniformBuffer=e.createBuffer({size:this.uniformBufferSize,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),this.uniformBindGroup=e.createBindGroup({layout:this.renderPipeline.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:this.uniformBuffer,offset:0,size:this.matrixSize}}]}),this.verticesBuffer=e.createBuffer({size:r.byteLength,usage:GPUBufferUsage.VERTEX,mappedAtCreation:!0}),new Float32Array(this.verticesBuffer.getMappedRange()).set(r),this.verticesBuffer.unmap(),this.setTransformation(o)}static cube(e){return new h(u,F,N,e)}static pyramid(e){return new h(u,q,G,e)}draw(e,r,n){this.updateTransformationMatrix(n.getCameraViewProjMatrix()),e.setPipeline(this.renderPipeline),r.queue.writeBuffer(this.uniformBuffer,0,this.modelViewProjectionMatrix.buffer,this.modelViewProjectionMatrix.byteOffset,this.modelViewProjectionMatrix.byteLength),e.setVertexBuffer(0,this.verticesBuffer),e.setBindGroup(0,this.uniformBindGroup),e.draw(this.vertexCount,1,0,0)}updateTransformationMatrix(e){const r=m();D(r,r,w(this.x,this.y,this.z)),V(r,r,this.rotX),C(r,r,this.rotY),z(r,r,this.rotZ),_(this.modelViewProjectionMatrix,e,r)}setTransformation(e){e!=null&&(this.x=e.x?e.x:0,this.y=e.y?e.y:0,this.z=e.z?e.z:0,this.rotX=e.rotX?e.rotX:0,this.rotY=e.rotY?e.rotY:0,this.rotZ=e.rotZ?e.rotZ:0)}}class W{constructor(){t(this,"objects",[])}add(e){this.objects.push(e)}getObjects(){return this.objects}}class I{constructor(e){t(this,"x",0);t(this,"y",0);t(this,"z",0);t(this,"rotX",0);t(this,"rotY",0);t(this,"rotZ",0);t(this,"fovy",2*Math.PI/5);t(this,"aspect",16/9);t(this,"near",1);t(this,"far",1e3);this.aspect=e}getViewMatrix(){let e=m();return O(e,w(this.x,this.y,this.z),w(0,0,0),w(0,1,0)),V(e,e,this.rotX),C(e,e,this.rotY),z(e,e,this.rotZ),e}getProjectionMatrix(){let e=m();return U(e,this.fovy,this.aspect,this.near,this.far),e}getCameraViewProjMatrix(){const e=m(),r=this.getViewMatrix(),n=this.getProjectionMatrix();return _(e,n,r),e}}class k{constructor(){t(this,"adapter");t(this,"canvas");t(this,"context");t(this,"format");t(this,"devicePixelRatio",window.devicePixelRatio|1);t(this,"swapChainFormat","bgra8unorm");t(this,"renderPassDescriptor");t(this,"presentationSize",[0,0])}async initEngine(e,r,n){this.canvas=e;let o=e.clientWidth*this.devicePixelRatio,i=e.clientHeight*this.devicePixelRatio;if(this.presentationSize=[o,i],!this.canvas)throw g.error("\u6CA1\u6709Canvas Element",10),new Error("\u6CA1\u6709Canvas Element");if(!navigator.gpu)throw g.error("\u4E0D\u652F\u6301\u4F7F\u7528\u663E\u5361\u8BBE\u5907",10),new Error("\u4E0D\u652F\u6301\u663E\u5361\u8BBE\u5907");if(this.adapter=await navigator.gpu.requestAdapter({powerPreference:r||"high-performance"})||void 0,!this.adapter)throw g.error("\u83B7\u53D6\u663E\u5361\u8BBE\u5907\u5931\u8D25",10),new Error("\u83B7\u53D6\u663E\u5361\u8BBE\u5907\u5931\u8D25");let l=await this.adapter.requestDevice();if(R(l),!u)throw g.error("\u663E\u5361\u8BBE\u5907\u672A\u627E\u5230",10),new Error("\u663E\u5361\u8BBE\u5907\u672A\u627E\u5230");this.context=this.canvas.getContext("webgpu"),this.format=this.context.getPreferredFormat(this.adapter),n||(n={device:u,format:this.format,size:this.presentationSize,usage:GPUTextureUsage.RENDER_ATTACHMENT,compositingAlphaMode:"opaque"}),this.context.configure(n);const c=this.depthTextureView();return this.renderPassDescriptor={colorAttachments:[{view:void 0,loadOp:"clear",loadValue:{r:.5,g:.5,b:.5,a:1},storeOp:"store",clearValue:{r:.5,g:.5,b:.5,a:1}}],depthStencilAttachment:{view:c,depthLoadOp:"clear",depthClearValue:1,depthLoadValue:1,depthStoreOp:"store",stencilLoadOp:"load",stencilClearValue:0,stencilStoreOp:"store"}},!0}get device(){return u}depthTextureView(){return u.createTexture({size:this.presentationSize,format:"depth24plus-stencil8",usage:GPUTextureUsage.RENDER_ATTACHMENT}).createView()}update(){this.renderPassDescriptor.depthStencilAttachment.view=this.depthTextureView()}frame(e,r){this.renderPassDescriptor.colorAttachments[0].view=this.context.getCurrentTexture().createView();const n=u.createCommandEncoder(),o=n.beginRenderPass(this.renderPassDescriptor);for(let i of r.getObjects())i.draw(o,u,e);o!=null&&o.endPass?o==null||o.endPass():o==null||o.end(),u.queue.submit([n.finish()])}}const J="_part_pfhqm_1",K="_card_pfhqm_1",Q="_footer_pfhqm_4";var $={part:J,card:K,footer:Q},E="/Users/indeex/Documents/program/indeex/program/webGPU/wgsl-base/src/component/part9/index.tsx";const oe=()=>{const[s,e]=B.exports.useState();B.exports.useEffect(()=>{r()},[]);const r=async()=>{const i=document.getElementById("gfx");i.width=document.body.clientWidth,i.height=document.body.clientHeight;const l=new k;await l.initEngine(i);const c=new I(i.width/i.height);c.z=7;const f=new W;e(f),f.add(h.cube({x:-2,y:1})),f.add(h.pyramid({x:2}));const P=()=>{const a=Date.now()/1e3;for(let d of f.getObjects())d.rotX=Math.sin(a),d.rotZ=Math.cos(a);l.frame(c,f),requestAnimationFrame(P)};P(),window.onresize=()=>{i.width=window.innerWidth,i.height=window.innerHeight,c.aspect=i.width/i.height,l.update()},i.onwheel=a=>{c.z+=a.deltaY/100};var v=!1;i.onmousedown=a=>{a.button===0&&(v=!0,p=a.pageX,x=a.pageY)},i.onmouseup=a=>{v=!1};var p=-1,x=-1;i.onmousemove=a=>{if(!!v){var d=a.pageX,b=a.pageY;if(p>0&&x>0){const S=d-p,j=b-x;c.rotY+=S/100,c.rotX+=j/100}p=d,x=b}},window.oncontextmenu=a=>{a.preventDefault(),Math.random()>.5?n(f):o(f)}},n=i=>{i.add(h.cube({x:(Math.random()-.5)*20,y:(Math.random()-.5)*10}))},o=i=>{i.add(h.pyramid({x:(Math.random()-.5)*20,z:(Math.random()-.5)*20}))};return y.createElement("div",{className:$.part,__self:globalThis,__source:{fileName:E,lineNumber:104,columnNumber:10}},y.createElement("canvas",{id:"gfx",__self:globalThis,__source:{fileName:E,lineNumber:105,columnNumber:5}}))};export{oe as default};
