var A=Object.defineProperty;var F=(u,e,r)=>e in u?A(u,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):u[e]=r;var t=(u,e,r)=>(F(u,typeof e!="symbol"?e+"":e,r),r);import{U as E,_ as U,R as V}from"./vendor.5b22622a.js";import{c as w,t as O,f as y,g as T,h as S,i as M,j as C,l as R,p as G,m as N}from"./vec3.d4a804b7.js";/* empty css              */let a;function j(u){a=u}var _;function I(u){_=u}var q=`struct FragmentInput {
    @location(0) heightFactor: f32;
};

@stage(fragment)
fn main(input: FragmentInput) -> @location(0) vec4<f32> {
    return vec4<f32>( vec3<f32>(0.6 * input.heightFactor, 0.6 * input.heightFactor, 0.6 * input.heightFactor).xyz, 1.0);
}`,L=`struct Uniforms {
    transform : mat4x4<f32>;
    rotate : mat4x4<f32>;
};

struct Camera {
    matrix : mat4x4<f32>;
};

@group(0) @binding(0) var<uniform> modelTransform    : Uniforms;
@group(0) @binding(1) var<uniform> cameraTransform   : Camera;
@group(0) @binding(2) var heightTexture: texture_2d<f32>;

struct VertexOutput {
    @builtin(position) Position : vec4<f32>;
    @location(0) heightFactor: f32;
};

struct VertexInput {
    @location(0) position : vec3<f32>;
    @location(1) norm : vec3<f32>;
    @location(2) uv : vec2<f32>;
};

@stage(vertex)
fn main(input: VertexInput) -> VertexOutput {
    var output: VertexOutput;
    var inputPos: vec3<f32> = input.position;
    var d : vec2<i32> = textureDimensions(heightTexture);
    var heightPixel: vec4<f32> = textureLoad(heightTexture, vec2<i32>( i32(input.uv.x * f32(d.x)), i32(input.uv.y * f32(d.y)) ), 0);
    var height: f32 = (heightPixel.x + heightPixel.y + heightPixel.z) / 3.0;
    inputPos = inputPos + input.norm * height * 10.0;
    var transformedPosition: vec4<f32> = modelTransform.transform * vec4<f32>(inputPos, 1.0);
    output.Position = cameraTransform.matrix * transformedPosition; 
    output.heightFactor = height;
    return output;
}`;class Z{constructor(){t(this,"vertices",[])}}function H(u,e,r,s){const i=new Z,n=[0,0,1],o=r/u,x=s/e,h=r/2,f=r/2;for(let P=-h;P<h;P+=o)for(let v=-f;v<f;v+=x){const p=P,d=v,l=p+o,m=d+x;i.vertices.push({pos:[p,d,0],norm:n,uv:[1-(p+h)/r,(d+f)/s]}),i.vertices.push({pos:[l,d,0],norm:n,uv:[1-(l+h)/r,(d+f)/s]}),i.vertices.push({pos:[p,m,0],norm:n,uv:[1-(p+h)/r,(m+f)/s]}),i.vertices.push({pos:[p,m,0],norm:n,uv:[1-(p+h)/r,(m+f)/s]}),i.vertices.push({pos:[l,d,0],norm:n,uv:[1-(l+h)/r,(d+f)/s]}),i.vertices.push({pos:[l,m,0],norm:n,uv:[1-(l+h)/r,(m+f)/s]})}return i}class k{constructor(e,r){t(this,"x",0);t(this,"y",0);t(this,"z",0);t(this,"rotX",0);t(this,"rotY",0);t(this,"rotZ",0);t(this,"width",1);t(this,"height",1);t(this,"numSegX",1);t(this,"numSegY",1);t(this,"matrixSize",4*16);t(this,"offset",256);t(this,"uniformBufferSize",this.offset);t(this,"transformMatrix",w());t(this,"rotateMatrix",w());t(this,"renderPipeline");t(this,"transformationBuffer");t(this,"transformationBindGroup");t(this,"verticesBuffer");t(this,"perVertex",3+3+2);t(this,"stride",this.perVertex*4);t(this,"mesh");this.setTransformation(e),this.mesh=H(this.numSegX,this.numSegY,this.width,this.height),this.renderPipeline=a.createRenderPipeline({vertex:{module:a.createShaderModule({code:L}),entryPoint:"main",buffers:[{arrayStride:this.stride,attributes:[{shaderLocation:0,offset:0,format:"float32x3"},{shaderLocation:1,offset:3*4,format:"float32x3"},{shaderLocation:2,offset:(3+3)*4,format:"float32x2"}]}]},fragment:{module:a.createShaderModule({code:q}),entryPoint:"main",targets:[{format:"bgra8unorm"}]},primitive:{topology:"triangle-list",cullMode:"back"},depthStencil:{depthWriteEnabled:!0,depthCompare:"less",format:"depth24plus-stencil8"}}),this.verticesBuffer=a.createBuffer({size:this.mesh.vertices.length*this.stride,usage:GPUBufferUsage.VERTEX,mappedAtCreation:!0});const s=new Float32Array(this.verticesBuffer.getMappedRange());for(let o=0;o<this.mesh.vertices.length;o++)s.set([this.mesh.vertices[o].pos[0],this.mesh.vertices[o].pos[1],this.mesh.vertices[o].pos[2]],this.perVertex*o+0),s.set(this.mesh.vertices[o].norm,this.perVertex*o+3),s.set(this.mesh.vertices[o].uv,this.perVertex*o+6);this.verticesBuffer.unmap(),this.transformationBuffer=a.createBuffer({size:this.uniformBufferSize,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});const i=[{binding:0,resource:{buffer:this.transformationBuffer,offset:0,size:this.matrixSize*2}},{binding:1,resource:{buffer:_,offset:0,size:this.matrixSize}}];let n=a.createTexture({size:[r.width,r.height,1],format:"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT});a.queue.copyExternalImageToTexture({source:r},{texture:n},[r.width,r.height,1]),i.push({binding:2,resource:n.createView()}),this.transformationBindGroup=a.createBindGroup({layout:this.renderPipeline.getBindGroupLayout(0),entries:i})}draw(e,r){this.updateTransformationMatrix(),e.setPipeline(this.renderPipeline),r.queue.writeBuffer(this.transformationBuffer,0,this.transformMatrix.buffer,this.transformMatrix.byteOffset,this.transformMatrix.byteLength),r.queue.writeBuffer(this.transformationBuffer,64,this.rotateMatrix.buffer,this.rotateMatrix.byteOffset,this.rotateMatrix.byteLength),e.setVertexBuffer(0,this.verticesBuffer),e.setBindGroup(0,this.transformationBindGroup),e.draw(this.mesh.vertices.length,1,0,0)}updateTransformationMatrix(){const e=w(),r=w();O(e,e,y(this.x,this.y,this.z)),T(e,e,this.rotX),S(e,e,this.rotY),M(e,e,this.rotZ),T(r,r,this.rotX),S(r,r,this.rotY),M(r,r,this.rotZ),C(this.transformMatrix,e),C(this.rotateMatrix,r)}setTransformation(e){e!=null&&(this.x=e.x?e.x:0,this.y=e.y?e.y:0,this.z=e.z?e.z:0,this.rotX=e.rotX?e.rotX:0,this.rotY=e.rotY?e.rotY:0,this.rotZ=e.rotZ?e.rotZ:0,this.width=e.width?e.width:1,this.height=e.height?e.height:1,this.numSegX=e.numSegX?e.numSegX:1,this.numSegY=e.numSegY?e.numSegY:1)}}class W{constructor(){t(this,"objects",[])}add(e){this.objects.push(e)}getObjects(){return this.objects}}class J{constructor(e){t(this,"x",0);t(this,"y",0);t(this,"z",0);t(this,"rotX",0);t(this,"rotY",0);t(this,"rotZ",0);t(this,"fovy",2*Math.PI/5);t(this,"aspect",16/9);t(this,"near",.1);t(this,"far",1e3);t(this,"lookAt",y(0,0,0));this.aspect=e}getViewMatrix(){let e=w();return R(e,y(this.x,this.y,this.z),this.lookAt,y(0,1,0)),T(e,e,this.rotX),S(e,e,this.rotY),M(e,e,this.rotZ),e}getProjectionMatrix(){let e=w();return G(e,this.fovy,this.aspect,this.near,this.far),e}getCameraViewProjMatrix(){const e=w(),r=this.getViewMatrix(),s=this.getProjectionMatrix();return N(e,s,r),e}}class K{constructor(){t(this,"adapter");t(this,"canvas");t(this,"context");t(this,"format");t(this,"devicePixelRatio",window.devicePixelRatio|1);t(this,"swapChainFormat","bgra8unorm");t(this,"renderPassDescriptor");t(this,"matrixSize",4*16);t(this,"presentationSize",[0,0])}async initEngine(e,r,s){this.canvas=e;let i=e.clientWidth*this.devicePixelRatio,n=e.clientHeight*this.devicePixelRatio;if(this.presentationSize=[i,n],!this.canvas)throw E.error("\u6CA1\u6709Canvas Element",10),new Error("\u6CA1\u6709Canvas Element");if(!navigator.gpu)throw E.error("\u4E0D\u652F\u6301\u4F7F\u7528\u663E\u5361\u8BBE\u5907",10),new Error("\u4E0D\u652F\u6301\u663E\u5361\u8BBE\u5907");if(this.adapter=await navigator.gpu.requestAdapter({powerPreference:r||"high-performance"})||void 0,!this.adapter)throw E.error("\u83B7\u53D6\u663E\u5361\u8BBE\u5907\u5931\u8D25",10),new Error("\u83B7\u53D6\u663E\u5361\u8BBE\u5907\u5931\u8D25");let o=await this.adapter.requestDevice();if(j(o),!a)throw E.error("\u663E\u5361\u8BBE\u5907\u672A\u627E\u5230",10),new Error("\u663E\u5361\u8BBE\u5907\u672A\u627E\u5230");this.context=this.canvas.getContext("webgpu"),this.format=this.context.getPreferredFormat(this.adapter),s||(s={device:a,format:this.format,size:this.presentationSize,usage:GPUTextureUsage.RENDER_ATTACHMENT}),this.context.configure(s);const x=this.depthTextureView();this.renderPassDescriptor={colorAttachments:[{view:void 0,loadOp:"clear",loadValue:{r:.5,g:.5,b:.5,a:1},storeOp:"store"}],depthStencilAttachment:{view:x,depthLoadOp:"clear",depthClearValue:10,depthStoreOp:"store",stencilLoadOp:"clear",stencilClearValue:0,stencilStoreOp:"store"}};let h=a.createBuffer({size:this.matrixSize,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});return I(h),!0}get device(){return a}depthTextureView(){return a.createTexture({size:this.presentationSize,format:"depth24plus-stencil8",usage:GPUTextureUsage.RENDER_ATTACHMENT}).createView()}update(){this.renderPassDescriptor.depthStencilAttachment.view=this.depthTextureView()}frame(e,r){const s=e.getCameraViewProjMatrix();a.queue.writeBuffer(_,0,s.buffer,s.byteOffset,s.byteLength),this.renderPassDescriptor.colorAttachments[0].view=this.context.getCurrentTexture().createView();const i=a.createCommandEncoder(),n=i.beginRenderPass(this.renderPassDescriptor);for(let o of r.getObjects())o.draw(n,a);n.end(),a.queue.submit([i.finish()])}}const Q="_part_pfhqm_1",$="_card_pfhqm_1",ee="_footer_pfhqm_4";var te={part:Q,card:$,footer:ee},re="assets/heightmap_01.7a9cb3a1.png",ie="assets/heightmap_02.4587d20e.png",se="assets/heightmap_03.7e1d558d.png",D="/Users/indeex/Documents/program/indeex/program/webGPU/wgsl-base/src/component/part10/index.tsx";const he=()=>{const[u,e]=U.exports.useState();U.exports.useEffect(()=>{r()},[]);const r=async(s=1)=>{const i=document.getElementById("gfx");i.width=document.body.clientWidth,i.height=document.body.clientHeight;const n=new J(i.width/i.height);n.z=30,n.y=15;const o=new W;e(o);const x=new K;await x.initEngine(i);const h=80,f=80,P=5,v=document.createElement("img");v.src=s===1?re:s===2?ie:se,await v.decode();const p=await createImageBitmap(v),d=new k({y:-P,width:h,height:f,rotX:-Math.PI/2,numSegX:512,numSegY:512},p);o.add(d);const l=()=>{x.frame(n,o),requestAnimationFrame(l)};l(),window.onresize=()=>{i.width=window.innerWidth,i.height=window.innerHeight,n.aspect=i.width/i.height,x.update()},i.onwheel=c=>{const g=c.deltaY/100;n.z>-g&&(n.z+=c.deltaY/100)};var m=!1;i.onmousedown=c=>{c.button===0&&(m=!0,b=c.pageX,B=c.pageY)},i.onmouseup=c=>{m=!1};var b=-1,B=-1;i.onmousemove=c=>{if(!!m){var g=c.pageX,z=c.pageY;if(b>0&&B>0){const Y=g-b,X=z-B;n.rotY+=Y/100,n.rotX+=X/100}b=g,B=z}},window.oncontextmenu=c=>{c.preventDefault();let g=Math.random();g<=.33&&r(1),g>.33&&g<=6.66&&r(2),g>.66&&r(3)}};return V.createElement("div",{className:te.part,__self:globalThis,__source:{fileName:D,lineNumber:109,columnNumber:10}},V.createElement("canvas",{id:"gfx",__self:globalThis,__source:{fileName:D,lineNumber:110,columnNumber:5}}))};export{he as default};
